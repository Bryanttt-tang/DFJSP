# Wait Action Reward Flow Diagram

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         REACTIVE RL WAIT ACTION FLOW                        │
└─────────────────────────────────────────────────────────────────────────────┘

┌──────────────┐
│ Agent takes  │
│ WAIT action  │
└──────┬───────┘
       │
       ▼
┌────────────────────────────────────────────────────────────────┐
│ step() calls _calculate_wait_reward()                         │
│   Input: scheduling_actions_available, current_event_time     │
└────────────────────┬───────────────────────────────────────────┘
                     │
                     ▼
        ┌────────────────────────┐
        │ Are scheduling actions │
        │     available?         │
        └────┬──────────────┬────┘
             │ NO           │ YES
             ▼              ▼
    ┌────────────────┐  ┌──────────────────────────────────────┐
    │  FORCED WAIT   │  │       OPTIONAL WAIT                  │
    │                │  │  (Agent chooses to wait)             │
    │ Reward = -0.1  │  └────────┬─────────────────────────────┘
    │   * wait_time  │           │
    └────────────────┘           ▼
                        ┌─────────────────────────┐
                        │ Is arrival_predictor    │
                        │ enabled AND confident?  │
                        └───┬────────────────┬────┘
                            │ YES            │ NO
                            │                │
                            ▼                ▼
                ┌──────────────────────┐  ┌────────────────────────┐
                │ PREDICTOR MODE       │  │ HEURISTIC MODE         │
                │                      │  │                        │
                │ 1. Predict arrivals  │  │ 1. Check machine util  │
                │ 2. Get confidence    │  │ 2. Count ready jobs    │
                │ 3. Time to arrival   │  │ 3. Next arrival time   │
                │                      │  │                        │
                │ Reward components:   │  │ Reward components:     │
                │ • Time penalty       │  │ • Time penalty         │
                │ • Utilization bonus  │  │ • Utilization bonus    │
                │ • PREDICTION BONUS   │  │ • Scarcity bonus       │
                │   (if arrival soon)  │  │ • Proximity bonus      │
                └──────────┬───────────┘  └────────┬───────────────┘
                           │                       │
                           └───────┬───────────────┘
                                   │
                                   ▼
                        ┌────────────────────────┐
                        │ USE_INTELLIGENT_REWARD │
                        │       flag?            │
                        └───┬────────────────┬───┘
                            │ TRUE           │ FALSE
                            ▼                ▼
                    ┌──────────────┐  ┌─────────────────┐
                    │ Return       │  │ Return simple   │
                    │ intelligent  │  │ penalty:        │
                    │ reward       │  │ -5.0 or -1.0    │
                    │ [-10, -0.5]  │  │                 │
                    └──────┬───────┘  └────────┬────────┘
                           │                   │
                           └─────────┬─────────┘
                                     │
                                     ▼
                          ┌────────────────────────┐
                          │ Return wait_reward to  │
                          │ step() function        │
                          └────────┬───────────────┘
                                   │
                                   ▼
                          ┌────────────────────────┐
                          │ Advance event_time to  │
                          │ next event (arrival or │
                          │ machine completion)    │
                          └────────┬───────────────┘
                                   │
                                   ▼
                          ┌────────────────────────┐
                          │ Observe new arrivals   │
                          │ (if predictor enabled) │
                          └────────┬───────────────┘
                                   │
                                   ▼
                          ┌────────────────────────┐
                          │ Return (obs, reward,   │
                          │         done, info)    │
                          └────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                            REWARD COMPONENTS DETAIL
═══════════════════════════════════════════════════════════════════════════════

HEURISTIC MODE:
┌────────────────────────────────────────────────────────────────────────────┐
│  time_penalty = -0.5 * min(wait_time, 20)              Range: [-10, 0]    │
│  utilization_bonus = 3.0 * machine_utilization          Range: [0, +3]    │
│  scarcity_bonus = 2.0 if num_ready_jobs ≤ 1 else 0.0   Range: [0, +2]    │
│  proximity_bonus = 3.0 * (1 - t_arrival/5) if t≤5       Range: [0, +3]    │
│                                                                            │
│  intelligent_reward = sum of above                      Range: [-10, +8]  │
│  final_reward = clamp(intelligent_reward, -10, -0.5)   Range: [-10,-0.5] │
└────────────────────────────────────────────────────────────────────────────┘

PREDICTOR MODE (when confidence > 0.3):
┌────────────────────────────────────────────────────────────────────────────┐
│  time_penalty = -0.5 * min(wait_time, 20)              Range: [-10, 0]    │
│  utilization_bonus = 3.0 * machine_utilization          Range: [0, +3]    │
│  prediction_bonus = 5.0 * (1-t_pred/3) * confidence     Range: [0, +5]    │
│    (only if predicted arrival ≤ 3 time units away)                        │
│                                                                            │
│  intelligent_reward = sum of above                      Range: [-10, +8]  │
│  final_reward = clamp(intelligent_reward, -10, -0.5)   Range: [-10,-0.5] │
└────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                              EXAMPLE SCENARIOS
═══════════════════════════════════════════════════════════════════════════════

Scenario 1: HIGH UTILIZATION + ARRIVAL SOON
┌────────────────────────────────────────────────────────────────────────────┐
│ State:                                                                     │
│   • Machines: 2/3 busy (utilization = 0.67)                               │
│   • Next arrival: in 2 time units                                         │
│   • Ready jobs: 1                                                         │
│   • Wait time: 2                                                          │
│                                                                            │
│ Calculation:                                                               │
│   time_penalty = -0.5 * 2 = -1.0                                          │
│   utilization_bonus = 3.0 * 0.67 = +2.0                                   │
│   scarcity_bonus = 2.0 (only 1 job)                                       │
│   proximity_bonus = 3.0 * (1 - 2/5) = +1.8                                │
│   Total = -1.0 + 2.0 + 2.0 + 1.8 = +4.8                                   │
│                                                                            │
│ Final reward: -0.5 (clamped)                                              │
│ ✅ WAITING IS GOOD! (minimal penalty)                                     │
└────────────────────────────────────────────────────────────────────────────┘

Scenario 2: LOW UTILIZATION + MANY JOBS
┌────────────────────────────────────────────────────────────────────────────┐
│ State:                                                                     │
│   • Machines: 0/3 busy (utilization = 0.0)                                │
│   • Next arrival: in 15 time units                                        │
│   • Ready jobs: 5                                                         │
│   • Wait time: 15                                                         │
│                                                                            │
│ Calculation:                                                               │
│   time_penalty = -0.5 * 15 = -7.5                                         │
│   utilization_bonus = 3.0 * 0.0 = 0.0                                     │
│   scarcity_bonus = 0.0 (many jobs)                                        │
│   proximity_bonus = 0.0 (arrival far)                                     │
│   Total = -7.5 + 0.0 + 0.0 + 0.0 = -7.5                                   │
│                                                                            │
│ Final reward: -7.5                                                        │
│ ❌ WAITING IS BAD! (strong penalty)                                       │
└────────────────────────────────────────────────────────────────────────────┘

Scenario 3: PREDICTOR MODE - CONFIDENT + IMMINENT ARRIVAL
┌────────────────────────────────────────────────────────────────────────────┐
│ State:                                                                     │
│   • Predictor confidence: 0.8 (high)                                      │
│   • Predicted arrival: in 1 time unit                                     │
│   • Machines: 1/3 busy (utilization = 0.33)                               │
│   • Wait time: 1                                                          │
│                                                                            │
│ Calculation:                                                               │
│   time_penalty = -0.5 * 1 = -0.5                                          │
│   utilization_bonus = 3.0 * 0.33 = +1.0                                   │
│   prediction_bonus = 5.0 * (1-1/3) * 0.8 = +2.67                          │
│   Total = -0.5 + 1.0 + 2.67 = +3.17                                       │
│                                                                            │
│ Final reward: -0.5 (clamped)                                              │
│ ✅ WAITING IS GOOD! (predictor gives strong signal)                       │
└────────────────────────────────────────────────────────────────────────────┘


═══════════════════════════════════════════════════════════════════════════════
                           CONFIGURATION QUICK REF
═══════════════════════════════════════════════════════════════════════════════

┌──────────────┬────────────────────┬────────────────────┬─────────────────┐
│ Mode         │ USE_INTELLIGENT    │ use_arrival_       │ Expected        │
│              │ _REWARD (line 779) │ predictor (init)   │ Performance     │
├──────────────┼────────────────────┼────────────────────┼─────────────────┤
│ Simple       │ False              │ False              │ Baseline        │
│ (Baseline)   │                    │                    │                 │
├──────────────┼────────────────────┼────────────────────┼─────────────────┤
│ Intelligent  │ True               │ False              │ Better          │
│ (Default)    │                    │                    │ (Recommended)   │
├──────────────┼────────────────────┼────────────────────┼─────────────────┤
│ Predictor    │ True               │ True               │ Best*           │
│ (Advanced)   │                    │                    │ (*consistent)   │
└──────────────┴────────────────────┴────────────────────┴─────────────────┘

```
